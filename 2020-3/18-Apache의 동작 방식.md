### Apache의 동작 방식

#### Apache

Client에서 요청을 받으면 MPM (Multi Processing Module - 다중처리모듈) 이라는 방식으로 처리를 하는데 대표적으로는 Prefork와 Worker방식이 있다



- Prefork MPM
  - 요청 하나당 하나의 프로세스를 할당하는 방식
  - 요청에 대한 처리가 각각의 프로세스에서 처리되므로 하나의 프로세스에서 오류가 발생하더라도 다른 프로세스에 영향을 미치지 않는다.
  - 요청이 많아짐에 따라 프로세스가 늘어나므로 시스템의 메모리, CPU 등 리소스에 부하가 생길 가능성이 높다.

- Worker MPM
  - 각각의 요청에 대해 프로세스가 여러개가 생성되는 것이 아닌 프로세스의 쓰레드를 여러개 생성하여 할당하는 방식
  - 다른 요청이라도 같은 프로세스내의 쓰레드를 사용하므로 메모리를 공유하게 된다. 그러므로 서로 영향을 미치게 된다.
  - Prefork 에 비해 적은 프로세스를 사용하므로 시스템 리소스의 부하가 비교적 적다.
  - 단일 프로세스에서 여러개의 쓰레드를 관리하므로 프로세스에 오류가 발생했을 경우에 그 안의 쓰레드에 영향을 미친다.
  - 한 프로세스의 쓰레드 한계치에 해당하는 대량의 연결이 발생하는 서버에서 적합하다.

- Event MPM
  - Nginx 에 비해 뒤떨어지는 퍼포먼스로 인해 Apache 2.4 버전부터 추가된 동작 방식
  - 이전의 두 방식은 프로세스가 요청에 대해 연결이 끊어지기 전까지 계속 연결을 유지하였다. 이와 같은 방식은 대량 접속의 경우에는 많은 시스템 리소스의 손실이 오게 된다.
    - KeepAlive
      - HTTP 프로토콜 특성상 한 번 통신이 이루어 지면 접속을 끊어버리지만 KeepAlive On 상태에서는 KeepAliveTimeOut 시간 동안 접속을 끊지 않고 다음 접속을 기다린다.
      - 정적 자원으로만 구성된 웹 서버에 KeepAlive On로 설정할 경우 약 50%의 성능 향상을 보인다.
      - 하지만 모든 요청 마다 연결을 유지해야 하기 때문에 프로세스 수가 기하 급수적으로 늘어나 Max Client값을 초과하게 된다.
      - 따라서 메모리를 많이 사용하게 되어 성능 저하의 원인이 된다. (대량 접속 시 효율이 떨어짐)
  - Event 방식에서는 이러한 문제를 해결하기 위해 요청을 받는 쓰레드를 분리하여 분산화하였다.



#### Apache 동작 설정

- 아파치의 동작 방식은 **http -V** 를 입력하여 확인할 수 있다. (Server MPM 부분)

- /etc/httpd/conf/httpd.conf 파일 또는 /etc/apache2/conf/httpd.conf 파일에서 설정이 가능하다.
- 위 파일을 열어보면 Prefork 와 Worker 밖에 안보이는데, Event 방식은 Worker 와 설정이 같기 때문에
  Event 방식을 적용하고자 한다면 Worker 의 설정을 수정해주면 된다.



#### Nginx

- 보안과 속도를 최적화 시키려는 노력에서 탄생한 웹서버이며, 사용이 매우 심플하고 규모가 작은 서비스이면서 정적 데이터 처리가 많은 서비스에 적합하다.

- Nginx는 프로그램의 흐름이 이벤트에 의해 결정이 되는 **Event Driven** 방식의 웹 서버이다.
  - 요청에 대한 각 상태(state)를 정해서, event가 발생할 때마다 event를 처리한다.
  - 적은 수의 쓰레드로 효율적인 일 처리를 하며, 쓰레드를 적게 사용 하기 때문에 쓰레드당 할당되는 메모리도 적게 사용하는 구조이다.

- 쓰레드를 많이 사용하지 않기 때문에 context switching 비용이 적고, 따라서 CPU 소모도 적다.

- 그러나 **모듈 개발이 어려우며 다양한 모듈이 없다는 것이 단점**이다.



#### Apahce와 Nginx 비교

- PHP 모듈 등을 직접 적재할 수 있는 Apache가 구조상 이점이 있기에 복잡한 웹 사이트의 경우 Apache가 적합하다.
- 세션 클러스터링 같은 특별한 목적을 추가적으로 수행하는 세팅을 할 경우에는 별도의 과정을 거쳐야 하기 때문에 이러한 별도의 작업이 많이 필요한 서비스의 경우에도 유지 보수 측면에서 Apache가 유용하다.
- **안정성과 확장성, 호환성**에서 **Apache**가 우세, **성능** 면에서는 **Nginx**가 우세하다. (Apache 2.4와 엄청 큰 차이는 아니라고 한다.)



